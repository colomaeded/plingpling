<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
<script src="FileSaver.js"></script>
<script type="text/javascript" > 
  var contexts = new Array();
  var version="0.1";
  var gameTitle="My Game";
  var gameLink="www.flipgame.org"
  var canvasIndex=0;
  var canvasses = new Array();
  var hyperlinks = new Array();

  var width=125;
  var height=140;
  var zoomFactor=4;
  var radius=5;

//1 for down, 2 for up
  var leftSweepArea = new Uint8Array(width*height);
  var rightSweepArea = new Uint8Array(width*height);
  var springSweepArea = new Uint8Array(width*height);

  var visibleCanvas;
  var visibleContext;
  var titleInput;
  var linkInput;
  var id;
  var id_d;

  var lastX=-1;
  var lastY=-1;

  var regionCanvasCount = 2;
  //canvas id 1 = empty space
  //canvas id 2 = regular wall
  var regionCanvas = new Uint32Array(width*height);
  var pivotPoints = [];
  var boundingBoxes = {};
  var regionTypes = [];

/*
//arne
  var colorPalette = [
           "#000000",
            "#c2c2c2",
            "#0000ff",
            "#bfe3f3",
            "#ff8700",
            "#ffff00",
            "#b4772c",
            "#ff0000",
            "#00bd00",
            "#bc4499",
            "#ffaf00",
            "#ffadd5",
            "#00ffff",
            "#005784",
            "#31A2F2",
            "#B2DCEF"
            ];
*/

//dawnbringer
//http://www.pixeljoint.com/forum/forum_posts.asp?TID=12795
  var colorPalette = [
          "#000000",//0
           "#000000",//1
            "#c2c2c2",//2
            "#0000ff",//3
            "#bfe3f3",//4
            "#ff8700",//5
            "#ffff00",//6
            "#b4772c",//7
            "#ff0000",//8
            "#00bd00",//9
            "#bc4499",//10
            "#ffaf00",//11
            "#00ffff",//12
            "#ffadd5",//13
            "#000079",//14
            "#8f0000",//15
            "#ff00ff", //16
            "#351d1d", //17
            ];

var eraserCol=0;
var wallCol=2;
var bumperCol=3;
var bumperAuraCol=14;
var flipperCol=4;
var leftFlipperPivotCol=5;
var rightFlipperPivotCol=6;
var ballSpawnCol=7;
var magnetCol=8;
var magnetAuraCol=15;
var connectionCol=9;
var targetCol=10;
var targetActiveCol=16;
var togglableWallCol=11;
var togglableWallDisabledCol=17;
var exitCol=13;
var springCol=12;

var lastPlacedLeftPivot=false;
/*
//spectrum 
  var colorPalette = [
            "#000000",
            "#888888",
            "#CDCDCD",
            "#FFFFFF",
            "#0000CD",
            "#0000FF",
            "#CD0000",
            "#FF0000",
            "#CD00CD",
            "#FF00FF",
            "#00CD00",
            "#00FF00",
            "#00CDCD",
            "#00FFFF",
            "#CDCD00",
            "#FFFF00"
            ];
*/
  var colorElem = new Array();
    var layerElem = new Array();

var aurl = document.createElement('a');
function qualifyURL(url) {
  aurl.href = url;
  return aurl.href;
}


var radiusElem = new Array();
  var thumbnailCanvas = new Array();
  var thumbnailContext = new Array();
  var dropdownOption = new Array();

var standalone_HTML_String="";

var clientStandaloneRequest = new XMLHttpRequest();

clientStandaloneRequest.open('GET', 'play.html');
clientStandaloneRequest.onreadystatechange = function() {

    if(clientStandaloneRequest.readyState!=4) {
      return;
    }
    standalone_HTML_String=clientStandaloneRequest.responseText;
}
clientStandaloneRequest.send();


var get_blob = function() {
    return self.Blob;
}

function buildStandalone(sourceCode) {
  if (standalone_HTML_String.length===0) {
    alert("Can't export yet - still downloading html template.",true);
    return;
  }
  sourceCode=encodeURI(sourceCode);
  var htmlString = standalone_HTML_String.concat("");


  htmlString = htmlString.replace(/__EMBED__/g,sourceCode);

  var BB = get_blob();
  var blob = new BB([htmlString], {type: "text/plain;charset=utf-8"});
  saveAs(blob, gameTitle+".html");
}

function exportClick(){
  var embedDat = stateToString();
  buildStandalone(embedDat);
}

function importClick(){
  var reader = new FileReader();

  reader.onload = function(e) {
   var text = reader.result;
  }

  reader.readAsText(file, encoding);
}
function shareClick() {
  var title = gameTitle;
  var str = stateToString();

  var gistToCreate = {
    "description" : title,
    "public" : true,
    "files": {
      "readme.txt" : {
        "content": "A game made with www.flipcode.org"
      },
      "game.txt" : {
        "content": str
      }
    }
  };

  var githubURL = 'https://api.github.com/gists';
  var githubHTTPClient = new XMLHttpRequest();
  githubHTTPClient.open('POST', githubURL);
  githubHTTPClient.onreadystatechange = function() {    
    var errorCount=0;
    if(githubHTTPClient.readyState!=4) {
      return;
    }   
    var result = JSON.parse(githubHTTPClient.responseText);
    if (githubHTTPClient.status===403) {
      errorCount++;
      alert(result.message);
    } else if (githubHTTPClient.status!==200&&githubHTTPClient.status!==201) {
      errorCount++;
      alert("HTTP Error "+ githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
    } else {
      var id = result.id;
      var url = "play.html?p="+id;
      url=qualifyURL(url);

      var editurl = "editor.html?hack="+id;
      editurl=qualifyURL(editurl);
      var sourceCodeLink = "link to source code:<br><a href=\""+editurl+"\">"+editurl+"</a>";

      var shareLink = document.getElementById("shareLink");
      shareLink.innerHTML = "<a target=\"_blank\" href=\""+url+"\">"+url+"</a><br>";


      if (errorCount>0) {
        alert("Cannot link directly to playable game, because there are errors.",true);
      } else {

      } 


    }
  }
  githubHTTPClient.setRequestHeader("Content-type","application/x-www-form-urlencoded");
  var stringifiedGist = JSON.stringify(gistToCreate);
  githubHTTPClient.send(stringifiedGist);
    lastDownTarget=canvas;  
}

function RLE_encode(input) {
    var encoding = [];
    var prev, count, i;
    for (count = 1, prev = input[0], i = 1; i < input.length; i++) {
        if (input[i] != prev) {
            encoding.push(count);
            encoding.push(prev);
            count = 1;
            prev = input[i];
        }
        else 
            count ++;
    }
    encoding.push(count);
    encoding.push(prev);
    return encoding;
}

function RLE_decode(encoded) {
    var output = "";
    encoded.forEach(function(pair){ output += new Array(1+pair[0]).join(pair[1]) })
    return output;
}

function stateToString(){
  var state = new Object();
  state.gameTitle=gameTitle;
  state.gameLink=gameLink;
  state.canvasses=new Array();
  for (var i=0;i<16;i++){
    var canvas=canvasses[i];
    var s="";
    for (var j=0;j<width*height;j++){
      s+=canvas[j].toString(16);
    }
    var pairs=RLE_encode(s);    
    state.canvasses.push(pairs);
  }
  state.hyperlinks=hyperlinks;
  var result=JSON.stringify(state);
  return result;
}

function stringToState(str){
  var state = JSON.parse(str);
  gameTitle=state.gameTitle;
  gameLink=state.gameLink;
  canvasIndex=0;
  canvasses=new Array();
  for (var k=0;k<state.canvasses.length;k++){
    var s = state.canvasses[k];
    var ar = new Uint8Array(width*height);
    var index=0;
    for (var i=0;i<s.length;i+=2){
      var count=s[i];
      var ch=s[i+1];
      for (var j=0;j<count;j++){
        ar[index]=parseInt(ch,16);
        index++;
      }
    }
    canvasses.push(ar);
  }

  hyperlinks=state.hyperlinks;
}

document.addEventListener("keydown", press);
document.addEventListener("keyup", keyup);

var copyImage = null;

var savedString;

var keyBuffer=[];

function setFlipperCanvas(){  
  canvasIndex=0;
  if (keyBuffer[37]===true){//left
    canvasIndex=1;
  } 
  if (keyBuffer[39]===true){
    canvasIndex+=2;
  }
  if (keyBuffer[40]===true){
    canvasIndex+=4;
  }
  //38 is up
  //40 is down
  setVisuals();
}

function keyup(evt){
  evt = evt || window.event;
  keyBuffer[evt.keyCode]=false;
  setFlipperCanvas();
}

function press(evt){
  evt = evt || window.event;
  keyBuffer[evt.keyCode]=true;
  /*
  if (evt.keyCode==83){//S(ave)
    savedString = stateToString();
  } else if (evt.keyCode==76){//L(oad)
    stringToState(savedString);
    setVisuals();
    setLayer(canvasIndex+1); 
  } */
  if (evt.keyCode===83){//s
    spawnBall();
  } else if (evt.keyCode===67) { //c
    floodFills();

    //copyImage=JSON.stringify(canvasses[canvasIndex])
  } else if (evt.keyCode===86){ //v
    if (copyImage!==null){
      preserveUndoState();
      var ar = JSON.parse(copyImage);
      var arui8 = new Uint8Array(width*height);
      for (var i=0;i<width*height;i++){
        arui8[i]=ar[i];
      }
      canvasses[canvasIndex]=arui8;
      setVisuals();
    }
  } else if (evt.keyCode ===189 || evt.keyCode===173 ) {//-
    if (radius===3) {
      setRadius(1);
    } else if (radius===5) {
      setRadius(3);
    }else if (radius===7) {
      setRadius(5);
    }else if (radius===9) {
      setRadius(7);
    }else if (radius===11) {
      setRadius(9);
    }else if (radius===13) {
      setRadius(11);
    }else if (radius===16) { 
      setRadius(13);
    }
  } else if (evt.keyCode===187 || evt.keyCode===61){//+
    if (radius===0){
      setRadius(1);
    } else if (radius===1){
      setRadius(3);
    } else if (radius===3) {
      setRadius(5);
    } else if (radius===5) {
      setRadius(7);
    }else if (radius===7) {
      setRadius(9);
    }else if (radius===9) {
      setRadius(11);
    }else if (radius===11) {
      setRadius(13);
    }else if (radius===13) {
      setRadius(16);
    }
  } else if (evt.keyCode===90){//z
    if (undoList.length>0){
      var dat = undoList.pop();
      canvasses[dat.canvasIndex]=dat.canvasDat;
      setVisuals();
    }
  }

  setFlipperCanvas();
}
  function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
  }

  var bucketElem;
  function titleChange(newTitle){
    gameTitle=newTitle;
  }

  function linkChange(newLink){
    gameLink=newLink;
  }

function clearPalette(){
  preserveUndoState();
  var canvas=canvasses[canvasIndex];
  for (var i=0;i<width*height;i++){
    canvas[i]=0;
  }
  setVisuals();
}
    function setRadius(newRadius) {
        radius=newRadius;
        bucketElem.setAttribute("class","radius");
        for(var i=0;i<16;i++){
          if (radiusElem[i]!==null){
            radiusElem[i].setAttribute("class","radius");
          }
        }
        if (newRadius>0){
          radiusElem[newRadius-1].setAttribute("class","radius selected");
        } else {
          bucketElem.setAttribute("class","radius selected");
        }
    }


var colorElem = new Array();

var ballSpawnPointX=width/2;
var ballSpawnPointY=height/2;

var bpx=-20;
var bpy=-20;
var ballFrame=0;
var ballPointFrames = [
[
      [1,0],[2,0],
[0,1],[1,1],      [3,1],
[0,2],            [3,2],
      [1,3],[2,3]
],
[
      [1,0],[2,0],
[0,1],      [2,1],[3,1],
[0,2],            [3,2],
      [1,3],[2,3]
],
[
      [1,0],[2,0],
[0,1],            [3,1],
[0,2],      [2,2],[3,2],
      [1,3],[2,3]
],
[
      [1,0],[2,0],
[0,1],            [3,1],
[0,2],[1,2],      [3,2],
      [1,3],[2,3]
]
];

  function collision(x,y){
    var indices = [
                                x+1+width*(y+0),x+2+width*(y+0),
                    x+0+width*(y+1),x+1+width*(y+1),x+2+width*(y+1),x+3+width*(y+1),
                    x+0+width*(y+2),x+1+width*(y+2),x+2+width*(y+2),x+3+width*(y+2),
                                x+1+width*(y+3),x+2+width*(y+3)
                    ];
    var canvas=canvasses[canvasIndex];

    var collisiondat = [];
    for (var i=0;i<indices.length;i++){
      var index = indices[i];
      var val = canvas[index];
      if (
            val>0 &&
            val!==bumperAuraCol &&
            val!==magnetAuraCol && 
            val!==ballSpawnCol &&
            val!==exitCol &&
            val!==connectionCol){
        var px = (index%width)+0.5;
        var py = Math.floor(index/width)+0.5;
        var dx = px-x-2;
        var dy = py-y-2;
        collisiondat.push([val,-dx,-dy]);
      }
    }
    return collisiondat;
  }
  function dropDownSelect(dropdown,val) {
    hyperlinks[canvasIndex][dropdown-1]=val;
  }

  function dot(v1,v2){
    return v1[0]*v2[0]+v1[1]*v2[1];
  }

  function mag (v){
    return Math.sqrt(v[0]*v[0]+v[1]*v[1]);
  }

  function normalized(v){
    var m = mag(v);
    return [v[0]/m,v[1]/m];
  }

  function addV(v1,v2){
    return [v1[0]+v2[0],v1[1]+v2[1]];
  }

  function subV(v1,v2){
    return [v1[0]-v2[0],v1[1]-v2[1]];
  }

  function mulV(s,v){
    return [s*v[0],s*v[1]];
  }

  var speedX=0;
  var speedY=1;
  var ballSpin=1;
  var tickRecalcs=0;
  var tickLength=33;
  var bounceDamp=0.8;
  var bumperSpeed=2.0;
  var maxSpeed=3.0;
  var maxBallSpin=4.0;
  var spinDamp=0.0002;
  function clampSpeed(){    
    var v=  [speedX,speedY];
    var speedMag = mag(v);
    if (speedMag>maxSpeed){
      speedN = normalized(v);
      v = mulV(maxSpeed,speedN);
      speedX=v[0];
      speedY=v[1];
    }
    if (Math.abs(ballSpin)>maxBallSpin){
      ballSpin=ballSpin/Math.abs(ballSpin)*maxBallSpin;
    }
  }
  var ballSpinSpeed=0.4;
  function tick(){
    var signum=ballSpin>0?1:-1;
    ballFrame=(((ballFrame+signum*Math.sqrt(Math.abs(ballSpin))*ballSpinSpeed)%4)+4)%4;

    var oldSpeedX=speedX;
    var oldSpeedY=speedY;

    if (bpx<-10){
      return;
    }
    var G=0.001;
    speedY+=G*tickLength;
    clampSpeed();
    var nx = bpx+speedX;
    var ny = bpy+speedY;
    var collisiondat = collision(Math.round(nx),Math.round(ny));
    if (collisiondat.length===0){
      bpx=nx;
      bpy=ny;
      if (isNaN(bpx)||isNaN(bpy)){
        console.log("eek nan");
      }
      tickRecalcs=0;
      ballSpin*=(1-spinDamp*tickLength);
    } else {
      var avgx=0;
      var avgy=0;
      var bumperCount=0;
      for (var i=0;i<collisiondat.length;i++){
        if (collisiondat[i][0]===bumperCol){
          bumperCount++;
        }
        avgx+=collisiondat[i][1];
        avgy+=collisiondat[i][2];
      }

      avgx/=collisiondat.length;
      avgy/=collisiondat.length;

      if (avgx===0&&avgy===0){
        //try go backwards
        if (speedX!==0||speedY!==0){
          avgx=-speedY;
          avgy=speedX;
        } else {
          console.log(yep);                
          return;
        }  
      }

      var normal = normalized([avgx,avgy]);
      var nSpeed = [-speedX,-speedY];

      if (bumperCount>0){
        var speedMag=mag(nSpeed);
        speedMag+=bumperSpeed;
        if (speedMag>maxSpeed){
          speedMag=maxSpeed;
        }
        nSpeed = mulV(speedMag,normalized(nSpeed));
        speedX=nSpeed[0];
        speedY=nSpeed[1];
        clampSpeed();
      }

      var direction = (nSpeed[0]*normal[1]-nSpeed[1]*normal[0]);
/*      if (direction<0){
        console.log("left");
      } else if (direction>0){
        console.log("right");
      } else {
        console.log("bang");
      }*/
      var refl = subV(mulV(2*dot(normal,nSpeed),normal),nSpeed);
      //add 50% of spin to the bounce
      speedX=bounceDamp*refl[0];
      speedY=bounceDamp*refl[1];
      
      leftV = [-normal[1],normal[0]];
      var ballSpinAmount=1.0;
      speedX+=ballSpinAmount*ballSpin*leftV[0]/2;
      speedY+=ballSpinAmount*ballSpin*leftV[1]/2;

      ballSpin/=2;      
      ballSpin+=direction*mag([speedX,speedY])*(1-bounceDamp)/2.0;
      
      clampSpeed();
      nx = bpx+speedX;
      ny = bpy+speedY;


      tickRecalcs++;

      var collisiondat = collision(Math.round(nx),Math.round(ny));
      if (collisiondat.length===0){
        bpx=nx;
        bpy=ny;
      if (isNaN(bpx)||isNaN(bpy)){
        console.log("eek nan");
      }
        tickRecalcs=0;
      } else {
        if (tickRecalcs<4){
          tick();
        } else {
          bpx=nx;
          bpy=ny;
        }
        return;

      }
    }
    setVisuals();
  }

    function init() {
      setInterval(tick, tickLength);

      titleInput=document.getElementById("titleInput");
      titleInput.value=gameTitle;

      linkInput=document.getElementById("linkInput");
      linkInput.value=gameLink;

      
      radii = new Array();
      for (var i=0;i<16;i++){
        elem = document.getElementById("radius_"+(i+1));                
        radiusElem[i]=elem;
        
      }

      for (var i=0;i<16;i++){
        elem = document.getElementById("col"+(i+1));
        dropdownOption[i] = elem;        
      }

      for (var i=0;i<16;i++){
        elem = document.getElementById("color_"+(i)); 
        if (elem!==null){       
          elem.style.backgroundColor=colorPalette[i];
          colorElem[i]=elem;
        }
      }

      for (var i=0;i<16;i++){
        elem = document.getElementById("layerItem"+(i+1));        
        layerElem[i]=elem;
      }


      bucketElem=document.getElementById("bucket");


      for (var i=0;i<16;i++){
        canvasses[i]=new Uint8Array(width*height);
      }

      for (var i=0;i<16;i++){
        hyperlinks[i] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
      }

      visibleCanvas = document.getElementById("mainCanvas");
      visibleCanvas.addEventListener('mousedown', mouseDown,false);
      visibleCanvas.addEventListener('mouseup', mouseUp,false);
      visibleCanvas.addEventListener('mousemove', mouseMove,false);
      visibleCanvas.addEventListener('mouseout', mouseOut,false);

      var fileUploader = document.getElementById("my_file");
      fileUploader.addEventListener('change', readFile, false);

      window.addEventListener('mouseup', mouseUp,false);

      visibleContext = visibleCanvas.getContext("2d");
      visibleContext.imageSmoothingEnabled= false;
      id = visibleContext.createImageData(1,1); // only do this once per page
      id_d=id.data;
      setVisuals();

      getData();
    }

  function readFile(evt) {
    //Retrieve the first (and only!) File from the FileList object
    var f = evt.target.files[0]; 

    if (f) {
      var r = new FileReader();
      r.onload = function(e) { 
        var contents = e.target.result;
        var fromToken="<!--__EmbedBegin__-->";
        var endToken="<!--__EmbedEnd__-->";
        var fromIndex=contents.indexOf(fromToken);
        var endIndex=contents.indexOf(endToken);
        var ss1 = contents.substr(fromIndex+fromToken.length,endIndex-fromIndex-fromToken.length);
        var ss2=ss1.substr(ss1.indexOf("=")+2);
        var decoded = decodeURI(ss2);
        var decoded2 = decoded.substring(0, decoded.length - 3);
        stringToState(decoded2);
        setVisuals();
      }
      r.readAsText(f);
    } else { 
      alert("Failed to load file");
    }
  }



  function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
      return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }


  function strip_http(url) {
     url = url.replace(/^https?:\/\//,'');
     return url;
  }

  function getData(){ 
    var id = getParameterByName("p").replace(/[\\\/]/,"");
    if (id===null||id.length===0) {
      
      return;
    }

    var githubURL = 'https://api.github.com/gists/'+id;

    var githubHTTPClient = new XMLHttpRequest();
    githubHTTPClient.open('GET', githubURL);
    githubHTTPClient.onreadystatechange = function() {
      if(githubHTTPClient.readyState!=4) {
        return;
      }   
      var result = JSON.parse(githubHTTPClient.responseText);
      if (githubHTTPClient.status===403) {
        alert(result.message);
      } else if (githubHTTPClient.status!==200&&githubHTTPClient.status!==201) {
        alert("HTTP Error "+ githubHTTPClient.status + ' - ' + githubHTTPClient.statusText);
      }
      var result = JSON.parse(githubHTTPClient.responseText);
      var code=result["files"]["game.txt"]["content"];
      
      stringToState(code);
      setVisuals();
    }
    githubHTTPClient.setRequestHeader("Content-type","application/x-www-form-urlencoded");
    githubHTTPClient.send();
  }


  var lastbpx;
  var lastbpy;
  var lastBallFrame=ballFrame;

    function setVisuals(){
      //visibleContext.drawImage(canvasses[canvasIndex], 0, 0); 
      //visibleContext.drawImage(canvasses[canvasIndex], 0, 0,width*zoomFactor,height*zoomFactor); 
      canvas=canvasses[canvasIndex];
      for (var i=0;i<width;i++){
        for (var j=0;j<height;j++){
          var pixelIndex = canvas[i+width*j]; 
          visibleContext.fillStyle=colorPalette[pixelIndex];
          visibleContext.fillRect(i*zoomFactor,j*zoomFactor,zoomFactor,zoomFactor);        
        }
      }


      if (mag([speedX,speedY])>2) {
        var ballPoints=ballPointFrames[Math.floor(lastBallFrame)];
        visibleContext.fillStyle="#888888";
        for (var i=0;i<ballPoints.length;i++){
          var bp = ballPoints[i];
          var pi=Math.round(lastbpx+bp[0]);
          var pj=Math.round(lastbpy+bp[1]);
          visibleContext.fillRect(pi*zoomFactor,pj*zoomFactor,zoomFactor,zoomFactor);
        }
      }
      var ballPoints=ballPointFrames[Math.floor(ballFrame)];
      visibleContext.fillStyle="#ffffff";
      for (var i=0;i<ballPoints.length;i++){
        var bp = ballPoints[i];
        var pi=Math.round(bpx+bp[0]);
        var pj=Math.round(bpy+bp[1]);
        visibleContext.fillRect(pi*zoomFactor,pj*zoomFactor,zoomFactor,zoomFactor);
      }
      lastbpy=bpy;
      lastbpx=bpx;
      titleInput.value=gameTitle;
      linkInput.value=gameLink;
      lastBallFrame=Math.floor(ballFrame);
    }


  var drawing=0;


  function getCoords(e) {
    var x,y; 
    if(typeof e.offsetX !== "undefined") {
        x = e.offsetX;
        y = e.offsetY;
    }
    else {      
      var target = e.target || e.srcElement;
      var rect = target.getBoundingClientRect();
      x = e.clientX - rect.left,
      y = e.clientY - rect.top;
    } 
    return [x,y];
  }



  function uint8ar_copy(src)  {
      var dst = new Uint8Array(width*height);
      for (var i=0;i<src.length;i++){
        dst[i]=src[i];
      }
      return dst;
  }

  var undoList=new Array();
  function preserveUndoState() {
    console.log("preserving undo state");
    var undoItem = new Object();
    undoItem.canvasIndex=canvasIndex;
    undoItem.canvasDat=uint8ar_copy(canvasses[canvasIndex]);
    undoList.push(undoItem);
    if (undoList.length>30){
      undoList.shift();
    }
  }

  function mouseDown(e){
    e = e || window.event;

    drawing=1;
    var coords = getCoords(e);
    startTargetX=coords[0];
    startTargetY=coords[1];
    lastX=Math.floor(-1+startTargetX/zoomFactor);
    lastY=Math.floor(-1+startTargetY/zoomFactor);
    
    preserveUndoState();
    mouseMove(e,e.type==="mousedown");
    if(radius===0){
      drawing=0;
    }
  }

  function mouseUp(e){
    e = e || window.event;
    calcHalo();
    setVisuals();
    drawing=0;
    lastX=-1;
    lastY=-1;
  }

  function mouseOut(e){
    e = e || window.event;

    mouseMove(e);
    lastX=-1;
    lastY=-1;
  }

  var activeTool="wall";
  function selectTool(toolName,col){
    activeTool=toolName;
    for (var i=0;i<16;i++){
      var elem = colorElem[i];
      if (elem!=null){
        elem.setAttribute("class","unselected");
      }
    }
    colorElem[col].setAttribute("class","selected");
  }

  function line (x1, y1,x2,y2) {
    var coordinatesArray = new Array();
    // Translate coordinates
    // Define differences and error check
    var dx = Math.abs(x2 - x1);
    var dy = Math.abs(y2 - y1);
    var sx = (x1 < x2) ? 1 : -1;
    var sy = (y1 < y2) ? 1 : -1;
    var err = dx - dy;
    // Set first coordinates
    coordinatesArray.push([x1,y1]);
    // Main loop
    while (!((x1 == x2) && (y1 == y2))) {
      var e2 = err << 1;
      if (e2 > -dy) {
        err -= dy;
        x1 += sx;
      }
      if (e2 < dx) {
        err += dx;
        y1 += sy;
      }
      // Set coordinates
      coordinatesArray.push([x1,y1]);
    }
    // Return the result
    return coordinatesArray;
  }

function eraserDraw(x,y){
  //var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  var points = [
              [x-1,y+2],[x,y+2],[x+1,y+2],
    [x-2,y+1],[x-1,y+1],[x,y+1],[x+1,y+1],[x+2,y+1],
    [x-2,y  ],[x-1,y  ],[x,y  ],[x+1,y  ],[x+2,y  ],
    [x-2,y-1],[x-1,y-1],[x,y-1],[x+1,y-1],[x+2,y-1],
              [x-1,y-2],[x,y-2],[x+1,y-2]
    ];
  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=eraserCol;
    }
  }   
}

function wallDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=wallCol;
    }
  }   
}

function bumperDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=bumperCol;
    }
  }   
}

function flipperDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      val = canvas[px+width*py];
      if (val!==leftFlipperPivotCol&&val!==rightFlipperPivotCol){
        canvas[px+width*py]=flipperCol;
      }
    }
  }   


  neighbours=[[px+1,py],[px,py+1],[px-1,py],[px,py-1]];
  fillCanvas[px+width*py]=1;
  var foundflipper=false;
  for(var i=0;i<neighbours.length;i++){
    var n = neighbours[i];
    var nx=n[0];
    var ny=n[1];
    if (nx>=0&&nx<width&&ny>=0&&ny<height&&fillCanvas[nx+width*ny]===0){
      var val = canvas[nx+width*ny];
      if (  val===leftFlipperPivotCol   ||
            val===rightFlipperPivotCol  ||
            val===flipperCol 
          ) {
        if (foundflipper){
          canvas[nx+width*ny]=flipperCol;
        } else if (val===leftFlipperPivotCol||val===rightFlipperPivotCol){
          foundflipper=true;
        }
        fillCanvas[nx+width*ny]=1;
        neighbours.push([nx+1,ny]);
        neighbours.push([nx-1,ny]);
        neighbours.push([nx,ny+1]);
        neighbours.push([nx,ny-1]);
      }
    }
  }
  if (foundflipper===false){
    if (lastPlacedLeftPivot===false){
      canvas[x+width*y]=leftFlipperPivotCol;
    } else {
      canvas[x+width*y]=rightFlipperPivotCol;      
    }
    lastPlacedLeftPivot=!lastPlacedLeftPivot;
  }

  for (var i=0;i<width*height;i++){
    fillCanvas[i]=0;
  }

}

fillCanvas = new Uint8Array(width*height);
function leftFlipperPivotDraw(x,y){
  var px=x;
  var py=y;

  if (px>=0&&px<width&&py>=0&&py<height){
    canvas[px+width*py]=leftFlipperPivotCol;
  }
  neighbours=[[px+1,py],[px,py+1],[px-1,py],[px,py-1]];
  fillCanvas[px+width*py]=1;
  for(var i=0;i<neighbours.length;i++){
    var n = neighbours[i];
    var nx=n[0];
    var ny=n[1];
    if (nx>=0&&nx<width&&ny>=0&&ny<height&&fillCanvas[nx+width*ny]===0){
      var val = canvas[nx+width*ny];
      if (  val===leftFlipperPivotCol   ||
            val===rightFlipperPivotCol  ||
            val===flipperCol 
          ) {
        canvas[nx+width*ny]=flipperCol;
        fillCanvas[nx+width*ny]=1;
        neighbours.push([nx+1,ny]);
        neighbours.push([nx-1,ny]);
        neighbours.push([nx,ny+1]);
        neighbours.push([nx,ny-1]);
      }
    }

  }

  for (var i=0;i<width*height;i++){
    fillCanvas[i]=0;
  }
}


function rightFlipperPivotDraw(x,y){
  var px=x;
  var py=y;

  if (px>=0&&px<width&&py>=0&&py<height){
    canvas[px+width*py]=rightFlipperPivotCol;
  }
  neighbours=[[px+1,py],[px,py+1],[px-1,py],[px,py-1]];
  fillCanvas[px+width*py]=1;
  for(var i=0;i<neighbours.length;i++){
    var n = neighbours[i];
    var nx=n[0];
    var ny=n[1];
    if (nx>=0&&nx<width&&ny>=0&&ny<height&&fillCanvas[nx+width*ny]===0){
      var val = canvas[nx+width*ny];
      if (  val===leftFlipperPivotCol   ||
            val===rightFlipperPivotCol  ||
            val===flipperCol 
          ) {
        canvas[nx+width*ny]=flipperCol;
        fillCanvas[nx+width*ny]=1;
        neighbours.push([nx+1,ny]);
        neighbours.push([nx-1,ny]);
        neighbours.push([nx,ny+1]);
        neighbours.push([nx,ny-1]);
      }
    }

  }

  for (var i=0;i<width*height;i++){
    fillCanvas[i]=0;
  }
}

function ballSpawnDraw(x,y){
  var px=x;
  var py=y;
  for(var i=0;i<width*height;i++){
    if (canvas[i]===ballSpawnCol){
      canvas[i]=0;
    }
  }
  if (px<3){
    px=3;
  } else if (px>width-3){
    px=width-3;
  }
  if (py<3){
    py=3;
  } else if (py>height-3){
    py=height-3;
  }

  var points = [
                [px-3,py-0],
                [px-3,py-1],
                [px-2,py-2],
                [px-1,py-3],
                [px+0,py-3],
                [px+1,py-2],
                [px+2,py-1],
                [px+2,py-0],
                [px+1,py+1],
                [px+0,py+2],
                [px-1,py+2],
                [px-2,py+1]
                ];
  for (var i=0;i<points.length;i++){
    var p = points[i];
    canvas[p[0]+width*p[1]]=ballSpawnCol;
  }
}

function magnetDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=magnetCol;
    }
  }   
}

function connectionDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y-1],[x-1,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=connectionCol;
    }
  }   
}

function targetDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=targetCol;
    }
  }   

}

function toggableWallDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=togglableWallCol;
    }
  }   
}

function springDraw(x,y){
  var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];

  for (var i=0;i<points.length;i++){
    var px=points[i][0];
    var py=points[i][1];
    if (px>=0&&px<width&&py>=0&&py<height){
      canvas[px+width*py]=springCol;
    }
  }   
}

function exitPointDraw(x,y){
  var px=x;
  var py=y;
  for(var i=0;i<width*height;i++){
    if (canvas[i]===exitCol){
      canvas[i]=0;
    }
  }
  if (px<2){
    px=2;
  } else if (px>width-3){
    px=width-3;
  }
  if (py<2){
    py=2;
  } else if (py>height-3){
    py=height-3;
  }

  var points = [
                [px,py],
                [px-1,py-1],[px-2,py-2],
                [px+1,py-1],[px+2,py-2],
                [px-1,py+1],[px-2,py+2],
                [px+1,py+1],[px+2,py+2]
                ];
  for (var i=0;i<points.length;i++){
    var p = points[i];
    canvas[p[0]+width*p[1]]=exitCol;
  }
}


  var interpolateBrush = {
    eraser: true,
    wall: true,
    bumper: true,
    flipper: true,
    leftFlipperPivot: false,
    rightFlipperPivot: false,
    ballSpawn: false,
    magnet: true,
    connection: true,
    target: true,
    toggableWall: true,
    spring: true,
    exitPoint: false
  }

  var drawFuncs = {
    eraser: eraserDraw,
    wall: wallDraw,
    bumper: bumperDraw,
    flipper: flipperDraw,
    leftFlipperPivot: leftFlipperPivotDraw,
    rightFlipperPivot: rightFlipperPivotDraw,
    ballSpawn: ballSpawnDraw,
    magnet: magnetDraw,
    connection: connectionDraw,
    target: targetDraw,
    toggableWall: toggableWallDraw,
    spring: springDraw,
    exitPoint: exitPointDraw
  }

  function mouseMove(e,mousedown){
    e = e || window.event;

    if (drawing===0)
      return;

    var coords = getCoords(e);

    var x = Math.floor(-1+coords[0]/zoomFactor);
    var y = Math.floor(-1+coords[1]/zoomFactor);


    var canvas=canvasses[canvasIndex];

    var points;
    if (interpolateBrush[activeTool]===false||lastX<0||lastY<0) {
      points=[[x,y]];
    } else {
      points=line(lastX,lastY,x,y);
    }

    var brushFn=drawFuncs[activeTool];
    for (var i=0;i<points.length;i++){
     var p=points[i];
     brushFn(p[0],p[1]);
    }
  

    /*context.beginPath();
    context.arc(x, y, radius, 0, 2 * Math.PI, false);
    context.lineWidth = 0;
    context.fillStyle = 'green';
    context.fill();*/
    setVisuals();

    var coords = getCoords(e);
    lastX=Math.floor(-1+coords[0]/zoomFactor);
    lastY=Math.floor(-1+coords[1]/zoomFactor);
    
  }

  function floodFills(){
    boundingBoxes = {};
    pivotPoints = {};

    for (var i=0;i<width*height;i++){
      regionCanvas[i]=0;
    }

    regionTypes=[];

    var ballSpawnPointCount=0;
    ballSpawnPointX=0;
    ballSpawnPointY=0;

    regionCanvasCount = 2;
    for (var x=0;x<width;x++){
      for (var y=0;y<height;y++) {
        if (regionCanvas[x+width*y]===0){
          var val =canvas[x+width*y];
          if (val===eraserCol||val===magnetAuraCol||val===bumperAuraCol){
            regionCanvas[x+width*y]=eraserCol;
          } else if (val===wallCol) {
            regionCanvas[x+width*y]=wallCol;
          } else {
            fillRegion(x,y,regionCanvasCount+1);
            regionCanvasCount++;
          }
        }
        if (canvas[x+width*y]===ballSpawnCol){
          ballSpawnPointX+=x;
          ballSpawnPointY+=y;
          ballSpawnPointCount++;
        }
      }
    }

    if (ballSpawnPointCount>0){
      ballSpawnPointX/=ballSpawnPointCount;
      ballSpawnPointY/=ballSpawnPointCount;
      ballSpawnPointX-=2;
      ballSpawnPointY-=2;
    } else {
      ballSpawnPointX=width/2;
      ballSpawnPointY=height/2;
    }

    drawBB();
    scrunchSprings();
    setVisuals();
  }

  function spawnBall(){
    bpx=ballSpawnPointX;
    bpy=ballSpawnPointY;
    ballSpin=maxBallSpin;
    speedX=0;
    speedY=0;
  }

  function fillRegion(x,y,regionNumber){
    var originCol=canvas[x+width*y];
    var originFlipper = 
      originCol===leftFlipperPivotCol ||
      originCol===rightFlipperPivotCol ||
      originCol===flipperCol;
    regionCoordIndex=x+width*y;
    regionCanvas[regionCoordIndex]=regionNumber;
    regionTypes[regionNumber]=canvas[regionCoordIndex];

    if ((regionNumber) in boundingBoxes){
      bbox = boundingBoxes[regionNumber];
      bbox[0]=Math.min(bbox[0],nx);
      bbox[1]=Math.min(bbox[1],ny);
      bbox[2]=Math.max(bbox[2],nx);
      bbox[3]=Math.max(bbox[3],ny);
    } else {
      boundingBoxes[regionNumber]=[x,y,x,y];
    }

    var neighbours = [[x+1,y],[x-1,y],[x,y+1],[x,y-1]];
    for(var i=0;i<neighbours.length;i++){
      var n = neighbours[i];
      var nx=  n[0];
      var ny = n[1];
      if (nx>=0&&nx<width&&ny>=0&&ny<height&&canvas[nx+width*ny]>wallCol &&regionCanvas[nx+width*ny]===0) {
        var val = canvas[nx+width*ny];
        if (val==originCol ||
              (originFlipper && (
                val === leftFlipperPivotCol ||
                val === rightFlipperPivotCol ||
                val === flipperCol ) ) ) {
          regionCanvas[nx+width*ny]=regionNumber;
          neighbours.push([nx+1,ny]);
          neighbours.push([nx-1,ny]);
          neighbours.push([nx,ny+1]);
          neighbours.push([nx,ny-1]);

          if (regionNumber in boundingBoxes){
            bbox = boundingBoxes[regionNumber];
            bbox[0]=Math.min(bbox[0],nx);
            bbox[1]=Math.min(bbox[1],ny);
            bbox[2]=Math.max(bbox[2],nx);
            bbox[3]=Math.max(bbox[3],ny);
          } else {
            boundingBoxes[regionNumber]=[nx,ny,nx,ny];
          }

          if (originFlipper){
            if (val===leftFlipperPivotCol) {
              pivotPoints[regionNumber]=[nx,ny,1];
            } else if (val === rightFlipperPivotCol){
              pivotPoints[regionNumber]=[nx,ny,2];
            }
          }
        }
      }
    }
  }

  function scrunchSprings(){
    var downNoneCanvas=uint8ar_copy(canvasses[0]);
    var downLeftCanvas=uint8ar_copy(canvasses[1]);
    var downRightCanvas=uint8ar_copy(canvasses[2]);
    var downBothCanvas=uint8ar_copy(canvasses[3]);
    canvasses[4]=downNoneCanvas;
    canvasses[5]=downLeftCanvas;
    canvasses[6]=downRightCanvas;
    canvasses[7]=downBothCanvas;


    //remove springs
    for (var i=0;i<regionCanvas.length;i++){
      var regionNumber = regionCanvas[i];
      if (regionTypes[regionNumber]===springCol){
        downNoneCanvas[i]=0;
        downLeftCanvas[i]=0;
        downRightCanvas[i]=0;
        downBothCanvas[i]=0;
      }
    }

    //redraw them at half height

    for (var regionNumberStr in boundingBoxes){
      var regionNumber=Number(regionNumberStr);
      if (regionTypes[regionNumber] !== springCol){
        continue;
      }
      var bbox = boundingBoxes[regionNumber];
      bottomy=bbox[3];
      for (var x=bbox[0];x<=bbox[2];x++){      
        for (var y=bbox[1];y<=bbox[3];y++){
          var i = x+width*y;
          if (regionCanvas[i]===regionNumber){
            var newy = (y-bottomy)/2+bottomy;
            newy=Math.round(newy);
            downNoneCanvas[x+width*newy]=springCol;
            downLeftCanvas[x+width*newy]=springCol;
            downRightCanvas[x+width*newy]=springCol;
            downBothCanvas[x+width*newy]=springCol;
          }
        }
      }
    }
  }

  function drawBB(){
    canvasses[0]=canvas;
    var leftCanvas=uint8ar_copy(canvas);
    var rightCanvas=uint8ar_copy(canvas);
    var bothCanvas=uint8ar_copy(canvas);
    canvasses[1]=leftCanvas;
    canvasses[2]=rightCanvas;
    canvasses[3]=bothCanvas;

    for (var i=0;i<regionCanvas.length;i++){
      var regionNumber = regionCanvas[i];
      if (regionNumber in pivotPoints){
        if(pivotPoints[regionNumber][2]===1){
          leftCanvas[i]=0;
          bothCanvas[i]=0;
        } else {
          rightCanvas[i]=0;
          bothCanvas[i]=0;
        }
      }
    }
/*
    for (var x=1;x<width-1;x++){
      for (var y=1;y<height-1;y++){
        var i = x+y*width;
        if (
          canvas[i]===magnetAuraCol || 
          canvas[i]===bumperAuraCol)
        {
          canvas[i]=0;
        }
      }
    }*/

    for (var regionNumberStr in pivotPoints){
      var regionNumber=Number(regionNumberStr);
      var ppoint = pivotPoints[regionNumber];
      var bbox = boundingBoxes[regionNumber];
      var orientation=ppoint[2];
      var targetCanvas;
      var targetAngle=30.0;
      var targetPivotCol;
      if (orientation===1){
        targetAngle=-targetAngle;
        targetCanvas=leftCanvas;
        targetPivotCol=leftFlipperPivotCol;
      } else {
        targetCanvas=rightCanvas;
        targetPivotCol=rightFlipperPivotCol;
      }

      var px=ppoint[0];
      var py=ppoint[1];
      theta=Math.PI*targetAngle/180.0;
      for (var x=bbox[0];x<=bbox[2];x++){      
        for (var y=bbox[1];y<=bbox[3];y++){
          var i = x+width*y;
          if (regionCanvas[i]===regionNumber){
            var dx=x-px;
            var dy=y-py;
            var px2=px+Math.cos(theta)*dx-Math.sin(theta)*dy;
            var py2=py+Math.sin(theta)*dx+Math.cos(theta)*dy;
            var points = [
                            [Math.floor(px2),Math.floor(py2)],
                            [Math.floor(px2),Math.ceil(py2)],
                            [Math.ceil(px2),Math.ceil(py2)],
                            [Math.ceil(px2),Math.floor(py2)]
                            ];
            for (var j=0;j<points.length;j++){
              var point2=points[j];
              var px3=point2[0];
              var py3=point2[1];
              if (px3>=0&&py3>=0&&px3<width&&py3<height){
                var index3=px3+width*py3;
                targetCanvas[index3]=flipperCol;
                bothCanvas[index3]=flipperCol;
              }
            }
           /* var linePoints = line(x,y,Math.round(px2),Math.round(py2));
            for (var j=0;j<linePoints.length;j++){
              var lp=linePoints[j];
              var lpx=lp[0];
              var lpy=lp[1];
              var index3 = lpx+width*lpy;
              if (canvas[index3]===0||canvas[index3]===magnetAuraCol){
                canvas[index3]=exitCol;
              }
            }*/
          }
        }
      }

      bothCanvas[px+width*py]=targetPivotCol;
      targetCanvas[px+width*py]=targetPivotCol;

    }
    canvasIndex=3;
  }

  function calcHalo(){
    for (var x=1;x<width-1;x++){
      for (var y=1;y<height-1;y++){
        var val = canvas[x+width*y];
        if (val===0 || val===magnetAuraCol || val===bumperAuraCol) {
          var neighbours = [
            [x-1,y-1],[x,y-1],[x+1,y-1],
            [x-1,y],      [x+1,y],
            [x-1,y+1],[x,y+1],[x+1,y+1]];
          canvas[x+width*y]=0;
          for (var i=0;i<neighbours.length;i++){
            var n = neighbours[i];
            var nx = n[0];
            var ny = n[1];
            var v = canvas[nx+width*ny];
            if (v===bumperCol){
              canvas[x+width*y]=bumperAuraCol;
              break;
            } else if (v===magnetCol){
              canvas[x+width*y]=magnetAuraCol; 
              break;             
            }
          }
        }
      }
    }
  }

  function drawCircle(canvas,x,y,radius,colorIndex){  
    radius=Math.floor(radius/2)+1;
    if (radius==2){
      var points = [[x,y],[x-1,y],[x,y+1],[x+1,y],[x,y-1]];
      for (var i=0;i<points.length;i++){
        var px=points[i][0];
        var py=points[i][1];
        if (px>=0&&px<width&&py>=0&&py<height){
          canvas[px+width*py]=colorIndex;
        }
      }
      return;
    } else if (radius==3){
      var points = [
                  [x-1,y+2],[x,y+2],[x+1,y+2],
        [x-2,y+1],[x-1,y+1],[x,y+1],[x+1,y+1],[x+2,y+1],
        [x-2,y  ],[x-1,y  ],[x,y  ],[x+1,y  ],[x+2,y  ],
        [x-2,y-1],[x-1,y-1],[x,y-1],[x+1,y-1],[x+2,y-1],
                  [x-1,y-2],[x,y-2],[x+1,y-2]
        ];
      for (var i=0;i<points.length;i++){
        var px=points[i][0];
        var py=points[i][1];
        if (px>=0&&px<width&&py>=0&&py<height){
          canvas[px+width*py]=colorIndex;
        }
      }
      return;

    }

    for (var i=Math.max(x-radius,0);i<=Math.min(x+radius,width-1);i++){
      for (var j=Math.max(y-radius,0);j<=Math.min(y+radius,height-1);j++){
        var dx = i-x;
        var dy = j-y;
        if ((dx*dx+dy*dy)<radius*radius){
          canvas[i+width*j]=colorIndex;          
        }
      }
    }  
  }

  function floodFill(canvas,x,y,colorIndex){
    var points = [[x,y]];
    originColor = canvas[x+width*y];
    if (originColor===colorIndex){
      return;
    }

    for (var i=0;i<points.length;i++){
      var p = points[i];
      var pIndex = p[0]+width*p[1];
      if (canvas[pIndex]===colorIndex) {
        continue;
      } else {
        canvas[pIndex]=colorIndex;
        borderPoints = [[p[0]+1,p[1]],[p[0]-1,p[1]],[p[0],p[1]+1],[p[0],p[1]-1]];
        for (var j=0;j<borderPoints.length;j++){
          var borderPoint=borderPoints[j]; 
          var borderpx=borderPoint[0];
          var borderpy=borderPoint[1];
          var bpi=bpx+width*bpy;
          if (
            borderpx>=0 &&
            borderpx<width &&
            borderpy>=0 &&
            borderpy<height &&
            canvas[bpi]===originColor){
            points.push([borderpx,borderpy]);
          }
        }
      }
    }
  }
</script>

    <style type="text/css">
/*<![CDATA[*/
#maincanvas {
  cursor:crosshair;
}
body {
    -webkit-user-select: none; /* webkit (safari, chrome) browsers */
    -moz-user-select: none; /* mozilla browsers */
    -khtml-user-select: none; /* webkit (konqueror) browsers */
    -ms-user-select: none; /* IE10+ */ 
}
                 select {
                  background-color:black;
                  color:white;
                  text-indent:5px;
                 }
                canvas {
                  position:relative;
                }
                 body {
                 background-color:black;
                 color: gray;
                 margin-top: 0;
                 padding-top: 0;
                 border-top: 0;
                 }
                 ul {
                 list-style-type: none;
                 overflow:hidden; overflow-y:scroll;
                 }
                 input {
                 background-color: black;
                 color:white;
                 text-align: center;
                 font-size: 100%;
                 }
                 input#linkInput {
                 background-color: black;
                 color:white;
                 text-align: center;
                 font-size: 100%;
                 }
                 li {
                 font-size: 150%;                 
                  text-align: center;
                  width:100%;
                 }
                 a {
                  color:white;
                 }
                 a.layerItem{
                  color: white;
                  background-color: black;
                  text-decoration: none;
                  width:100%;
                  display:block;
                 }
                 a.layerItem.selectedItem{
                  color: black;
                  background-color: white;
                 }
                 img.selected {
                  border: 2px solid red;
                 }
                 li.selected  {
                 cursor:auto;
                 color:white;
                 }
                 a{
                  white-space:nowrap;
                }
                 div.selected {
                 height:16px; 
                 width:30px;
                 border: 2px solid red;
                 }
                 div.unselected {
                 height:16px; 
                 width:30px;
                 border: 2px solid black;
                 }
                 span.selected {
                 height:16px; 
                 width:30px;
                 border: 2px solid red;
                 }
                 span.unselected {
                 height:16px; 
                 width:30px;
                 border: 2px solid black;
                 }
                 img.radius {
                  border: 1px solid black;
                 }
                 img.selected {
                  border: 1px solid red; 
                 }
                 select {
                 width:100%;
                 -webkit-appearance: none;
                 -moz-appearance: none;
                 }
                 select::-ms-expand {
                 display: none;
                 }
                 canvas#dropdownthumb {
                  border:2px solid gray; 
                  background-color:black;
                 }
    /*]]>*/
    </style>
    <title>
      pinballl
    </title>
  </head>
  <body onload="init();" ondragstart="return false;" ondrop="return false;">
  <center>
    <table cellpadding="10">
      <tr>
        <td valign="top">
          <table>
            <tr>
              <td>
                <table>
                  <tr>
                    <td>
                      <center>
                        <input width="640" style="border:2px solid gray;" onkeydown="event.stopPropagation();" value="game title"  id="titleInput" oninput="titleChange(this.value)" />
                        <input width="640" style="border:2px solid gray;" onkeydown="event.stopPropagation();" value="www.flipgame.org"  id="linkInput" oninput="linkChange(this.value)" />
                        <br/>
                        <canvas id="mainCanvas" width="500" height="560" style="border:2px solid gray; background-color:black;"></canvas>
                        <br />
                        
                      </center>
                    </td>
                    <td valign="top">
                      <a href="#" onclick="shareClick();return false;">&ocir; share</a><br />
                      <div id="shareLink"></div>
                      <a href="#" onclick="exportClick();return false;">&sdotb; export</a><br />
                      <a href="#" onclick="document.getElementById('my_file').click();return false;">&sdotb; import</a><br />
                      <input type="file" accept=".html" id="my_file" style="display: none;" />
                      <a href="hints.html" target="_blank" title="blah">? hints</a>
                      <br />
                      <br/>
                      <table border=1>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('eraser',1);return false;"><div class="unselected" id="color_1"></div>  
                          </td>
                          <td>
                            eraser
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('wall',2);return false;"><div class="unselected" id="color_2"></div>  
                          </td>
                          <td>
                            wall
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('bumper',3);return false;"><div class="unselected" id="color_3"></div>
                          </td>
                          <td>
                            bumper
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('flipper',4);return false;"><div class="unselected" id="color_4"></div>
                          </td>
                          <td>
                            flipper
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('leftFlipperPivot',5);return false;"><div class="unselected" id="color_5"></div>
                          </td>
                          <td>
                            left flipper pivot
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('rightFlipperPivot',6);return false;"><div class="unselected" id="color_6"></div>
                          </td>
                          <td>
                            right flipper pivot
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('ballSpawn',7);return false;"><div class="unselected" id="color_7"></div>
                          </td>
                          <td>
                            ball spawn
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('magnet',8);return false;"><div class="unselected" id="color_8"></div>
                          </td>
                          <td>
                            magnet
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('connection',9);return false;"><div class="unselected" id="color_9"></div>
                          </td>
                          <td>
                            connection
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('target',10);return false;"><div class="unselected" id="color_10"></div>
                          </td>
                          <td>
                            target
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('toggableWall',11);return false;"><div class="unselected" id="color_11"></div>
                          </td>
                          <td>
                            toggleable wall
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('spring',12);return false;"><div class="unselected" id="color_12"></div>
                          </td>
                          <td>
                            spring
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="selectTool('exitPoint',13);return false;"><div class="unselected" id="color_13"></div>
                          </td>
                          <td>
                            exit point
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="#" onclick="clearPalette();return false;" style=" text-decoration: none;"><div class="unselected" style="text-align:center;">X</div>
                          </td>
                          <td>
                            clear canvas
                          </td>
                        </tr>
                      </table>                      
                    </td>
                  </tr>
                </table>
                <br />
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
    </center>
  </body>
</html>